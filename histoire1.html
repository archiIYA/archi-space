<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Histoire de lâ€™Architecture 1</title>
  
  <script type="module">
  // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyBt4gf4Gan57N3M1PPQhWl5uXxp1Jcrkvk",
    authDomain: "archi-space-72624.firebaseapp.com",
    projectId: "archi-space-72624",
    storageBucket: "archi-space-72624.appspot.com",
    messagingSenderId: "407015246505",
    appId: "1:407015246505:web:c914a78566b882b80df7b8",
    measurementId: "G-RZV7LSDQBD"
  };

  // ØªÙ‡ÙŠØ¦Ø© Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "index.html";
    }
  });

  // ÙƒÙˆØ¯ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… (ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙÙƒ)
  document.addEventListener('DOMContentLoaded', () => {
    const premiumButton1 = document.getElementById('premiumButton1');
    const loadingMessage1 = document.getElementById('loadingMessage1');

    if (premiumButton1) {
      premiumButton1.addEventListener('click', async (e) => {
        e.preventDefault();
        
        loadingMessage1.textContent = 'ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§ÙƒÙƒ...';
        loadingMessage1.style.display = 'block';
        
        const user = auth.currentUser;

        if (!user) {
          loadingMessage1.textContent = 'ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.';
          return;
        }

        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          
          if (userDoc.exists() && userDoc.data().isPremium) {
            loadingMessage1.textContent = 'ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            const pdfRef = ref(storage, 'premium-files/histoire-lesson-1.pdf');
            const downloadURL = await getDownloadURL(pdfRef);
            
            loadingMessage1.textContent = 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙØŒ ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            window.open(downloadURL, '_blank');
            
          } else {
            loadingMessage1.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙ‚Ø·.';
          }
        } catch (error) {
          console.error("Ø­Ø¯Ø« Ø®Ø·Ø£:", error);
          loadingMessage1.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.';
        }
      });
    }
  });

  </script>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    /* === ØµÙØ­Ø© ArchiSpace Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ø­ÙÙˆØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª) === */
    body {
      margin: 0;
      font-family: 'Rubik', sans-serif;
      background: #fff;
      color: #111;
      display: flex;
      min-height: 100vh;
    }

    aside {
      width: 240px;
      background-color: #f4f4f4;
      height: 100vh;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      overflow-y: auto;
      position: fixed;
      left: 0;
      top: 0;
      transform: translateX(0);
      transition: transform 0.3s ease;
      z-index: 998;
    }

    aside.hidden {
      transform: translateX(-260px);
    }

    .back-button {
      margin-bottom: 20px;
      background-color: #ddd;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      transition: background-color 0.3s;
    }

    .back-button:hover {
      background-color: #ccc;
    }

    aside h2 {
      font-size: 18px;
      margin-bottom: 20px;
    }

    aside a {
      display: block;
      padding: 10px;
      margin-bottom: 10px;
      text-decoration: none;
      color: #333;
      border-radius: 6px;
      transition: background 0.3s;
    }

    aside a:hover {
      background-color: #ddd;
    }

    #toggleSidebar {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      background-color: #111;
      color: #fff;
      border: none;
      padding: 10px 15px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
    }

    main {
      flex-grow: 1;
      padding: 30px;
      margin-left: 240px;
      transition: margin-left 0.3s ease;
    }

    aside.hidden ~ main {
      margin-left: 0;
    }

    .section-title {
      font-size: 26px;
      margin-bottom: 20px;
      color: #000;
    }

    .lesson {
      margin-bottom: 30px;
      background: linear-gradient(180deg, #fbfbfb 0%, #ffffff 100%);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(8,24,40,0.06);
      border: 1px solid rgba(15,23,42,0.04);
    }

    .lesson h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #222;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .buttons {
      margin-top: 10px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .buttons a, .buttons button {
      background: none;
      border: 1px solid #e6e6e6;
      padding:8px 12px;
      border-radius:8px;
      margin-right: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      background-color:#fff;
    }

    .buttons a:hover, .buttons button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(8,24,40,0.06);
    }

    footer {
      margin-top: 50px;
      font-size: 13px;
      color: #888;
      text-align: center;
    }

    /* === Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„ÙƒÙˆÙŠØ² === */
    .quiz-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      background: linear-gradient(0deg, rgba(2,6,23,0.55), rgba(2,6,23,0.55));
      padding: 24px;
    }

    .quiz-card {
      width: 100%;
      max-width: 920px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 20px 50px rgba(2,6,23,0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: pop .18s ease;
    }

    @keyframes pop {
      from { transform: translateY(12px) scale(.99); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .quiz-header {
      padding: 18px 22px;
      background: linear-gradient(90deg,#0ea5a4,#0ea5a4 60%, #06b6d4 100%);
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .quiz-header h2 { margin:0; font-size:18px; }
    .quiz-controls { display:flex; gap:12px; align-items:center; }

    .quiz-body {
      padding: 22px;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 20px;
    }

    .question-area { background:#fbfdff; padding:18px; border-radius:10px; min-height:260px; }
    .question-index { font-size:13px; color:#666; margin-bottom:8px; }
    .question-text { font-size:18px; color:#0f172a; margin-bottom:12px; }

    .options { display:flex; flex-direction:column; gap:10px; }
    .option { background:#fff; border:1px solid #e6eef2; padding:12px 14px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px; }
    .option input { transform:scale(1.15); }
    .option.disabled { opacity:0.6; pointer-events:none; }

    .sidebar-panel { background:#ffffff; border-radius:10px; padding:14px; border:1px solid #eef6f9; height:100%; }
    .timer { font-weight:700; font-size:20px; color:#0f172a; }
    .meta { margin-top:12px; color:#475569; font-size:14px; }
    .nav-buttons { display:flex; gap:10px; margin-top:18px; }
    .btn { padding:10px 14px; border-radius:8px; background:#0ea5a4; color:#fff; border:none; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#e6eef2; color:#0f172a; }

    .close-quiz { background:transparent; border:0; color:rgba(255,255,255,0.9); font-weight:700; cursor:pointer; }

    .result { padding:20px; }
    .result h3 { margin-top:0; }
    .answers-list { margin-top:12px; display:flex; flex-direction:column; gap:10px; max-height:320px; overflow:auto; }
    .answer-item { background:#fcfcff; border:1px solid #eef2ff; padding:12px; border-radius:8px; }

    /* small screens */
    @media (max-width: 880px) {
      .quiz-body { grid-template-columns: 1fr; }
      .sidebar-panel { order: -1; }
      .quiz-card { max-width: 96%; }
    }
  </style>
</head>
<body>

<button id="toggleSidebar">â˜° Menu</button>

<aside class="sidebar">
  <a href="sem1.html" class="back-button">ğŸ”™ Retour Ã  Semestre 1</a>
  <button class="back-button" onclick="history.back()">ğŸ”™ Retour</button>

  <div class="sidebar-header">
    <h2>ğŸ“š AnnÃ©e 1 - Semestre 1</h2>
  </div>

  <ul class="sidebar-menu">
    <li><a href="atelier1.html">ğŸ—ï¸ Atelier de projet 1</a></li>
    <li><a href="dca1.html">ğŸ“ DCA 1</a></li>
    <li><a href="dag1.html">ğŸ¨ DAG 1</a></li>
    <li><a href="histoire1.html">ğŸ›ï¸ Histoire de lâ€™Architecture 1</a></li>
    <li><a href="theorie1.html">ğŸ“˜ ThÃ©orie de projet 1</a></li>
    <li><a href="geometrie1.html">ğŸ“ GÃ©omÃ©trie de lâ€™espace 1</a></li>
    <li><a href="tmc1.html">ğŸ§± TMC 1</a></li>
    <li><a href="math1.html">ğŸ§® MathÃ©matiques</a></li>
    <li><a href="expression1.html">ğŸ—£ï¸ Expression orale</a></li>
    <li><a href="stage.html">ğŸï¸ Stage dÃ©couverte 1</a></li>
    <hr>
    <li><a href="projets.html">ğŸ’¼ Projets</a></li>
    <li><a href="mailto:archispaceiya@gmail.com">ğŸ“© Contact</a></li>
  </ul>
</aside>

<main>
  <h1 class="section-title">ğŸ›ï¸ Histoire de lâ€™Architecture 1</h1>

  <div class="lesson">
    <h3>
      <span>La prÃ©histoire et les premiers refuges</span>
      <span>
        <button id="openQuizBtn" title="Ouvrir le quiz" style="background:#06b6d4;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">ğŸ“ Quiz</button>
      </span>
    </h3>
    <div class="buttons">
      <a href="cours_1_prehistoire.pdf">
        <button>ğŸ“„ PDF</button>
      </a>
      <button>ğŸ¥ VidÃ©o</button>
      <button id="premiumButton1">â­ Premium</button>
      <p id="loadingMessage1" style="display:none; color:#d9534f; margin-top:10px;"></p>
    </div>
  </div>

  <!-- Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯Ø±ÙˆØ³ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ -->
  <div class="lesson">
    <h3>Architecture mÃ©sopotamienne</h3>
    <div class="buttons">
      <a href="LA CIVILISATION MESOPOTAMIENNEzd.pdf">
        <button>ğŸ“„ PDF</button>
      </a>
      <button>ğŸ¥ VidÃ©o</button>
      <button>â­ Premium</button>
    </div>
  </div>

  <div class="lesson">
    <h3>Architecture Ã©gyptienne</h3>
    <div class="buttons">
      <a href="Egyptian civilization ENG.pdf">
        <button>ğŸ“„ PDF</button>
      </a>
      <button>ğŸ¥ VidÃ©o</button>
      <button>â­ Premium</button>
    </div>
  </div>

  <div class="lesson">
    <h3>Architecture grecque</h3>
    <div class="buttons">
      <a href="Greek civilization.pdf">
        <button>ğŸ“„ PDF</button>
      </a>
      <button>ğŸ¥ VidÃ©o</button>
      <button>â­ Premium</button>
    </div>
  </div>

  <div class="lesson">
    <h3>Architecture romaine</h3>
    <div class="buttons">
      <a href="La civilisation romaine antique.pdf">
        <button>ğŸ“„ PDF</button>
      </a>
      <button>ğŸ¥ VidÃ©o</button>
      <button>â­ Premium</button>
    </div>
  </div>

  <div class="lesson">
    <h3>Architecture palÃ©ochrÃ©tienne et byzantine</h3>
    <div class="buttons">
      <a href="Lâ€™architecture byzantine.pdf">
        <button>ğŸ“„ PDF</button>
      </a>
      <button>ğŸ¥ VidÃ©o</button>
      <button>â­ Premium</button>
    </div>
  </div>

  <div class="lesson">
    <h3>Architecture romane et gothique</h3>
    <div class="buttons">
      <a href="8 Art et architecture romane (1)_removed.pdf">
        <button>ğŸ“„ PDF</button>
      </a>
      <button>ğŸ¥ VidÃ©o</button>
      <button>â­ Premium</button>
    </div>
  </div>

  <footer>
    Â© 2025 ArchiSpace â€“ Tous droits rÃ©servÃ©s.
  </footer>
</main>

<!-- === Modal Quiz === -->
<div id="quizModal" class="quiz-modal" aria-hidden="true">
  <div class="quiz-card" role="dialog" aria-modal="true">
    <div class="quiz-header">
      <h2>Quiz â€” La prÃ©histoire et les premiers refuges</h2>
      <div class="quiz-controls">
        <div style="font-size:13px;opacity:0.95;">Choisissez le type :</div>
        <select id="quizTypeSelect" style="padding:6px 10px; border-radius:8px; border:none; font-weight:600;">
          <option value="QCM">QCM (choix multiples)</option>
          <option value="QCS">QCS (choix unique)</option>
          <option value="VF">Vrai / Faux</option>
        </select>
        <button class="close-quiz" id="closeQuizBtn">âœ•</button>
      </div>
    </div>

    <div class="quiz-body">
      <div class="question-area">
        <div class="question-index" id="questionIndex">Question 1 / 30</div>
        <div class="question-text" id="questionText">Choisissez un type puis dÃ©marrez.</div>

        <div class="options" id="optionsContainer">
          <!-- options gÃ©nÃ©rÃ©es Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>

        <div class="nav-buttons">
          <button class="btn secondary" id="prevBtn" disabled>â—€ PrÃ©cÃ©dent</button>
          <button class="btn secondary" id="nextBtn" disabled>Suivant â–¶</button>
          <button class="btn" id="submitBtn" style="display:none;">Soumettre</button>
        </div>
      </div>

      <div class="sidebar-panel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:13px;color:#64748b;">Timer</div>
            <div class="timer" id="timerDisplay">00:00</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px;color:#64748b;">Score</div>
            <div style="font-weight:700; font-size:18px;" id="scoreDisplay">0</div>
          </div>
        </div>

        <div class="meta">
          <div>Type: <span id="selectedType">â€”</span></div>
          <div style="margin-top:8px;">Questions totales: <b id="totalQuestions">30</b></div>
          <div style="margin-top:6px;">Questions restantes: <b id="remainingQuestions">30</b></div>
          <div style="margin-top:8px;">RÃ©essayer les mauvaises rÃ©ponses: <input type="checkbox" id="retryWrong" checked></div>
        </div>

        <div style="margin-top:14px;">
          <button class="btn" id="startBtn">Commencer</button>
          <button class="btn secondary" id="endEarlyBtn" style="margin-left:8px;">Finir maintenant</button>
        </div>

        <div style="margin-top:12px; font-size:13px; color:#475569;">
          <div>Navigation: utilisez â—€ / â–¶ ou les boutons.</div>
          <div style="margin-top:8px;">AprÃ¨s soumission, les erreurs seront regroupÃ©es et proposÃ©es Ã  nouveau.</div>
        </div>
      </div>
    </div>

    <div id="resultArea" style="display:none;" class="result">
      <h3>RÃ©sultat</h3>
      <div id="resultSummary"></div>
      <div class="answers-list" id="answersList"></div>
      <div style="margin-top:14px;">
        <button class="btn" id="retryBtn">Reprendre les questions incorrectes</button>
        <button class="btn secondary" id="closeResultBtn" style="margin-left:10px;">Fermer</button>
      </div>
    </div>

  </div>
</div>

<script>
/* Sidebar toggle */
const sidebar = document.querySelector('aside');
const toggleBtn = document.getElementById('toggleSidebar');
toggleBtn.addEventListener('click', () => sidebar.classList.toggle('hidden'));

/* Quiz logic */
const openQuizBtn = document.getElementById('openQuizBtn');
const quizModal = document.getElementById('quizModal');
const closeQuizBtn = document.getElementById('closeQuizBtn');
const startBtn = document.getElementById('startBtn');
const endEarlyBtn = document.getElementById('endEarlyBtn');
const submitBtn = document.getElementById('submitBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const questionText = document.getElementById('questionText');
const optionsContainer = document.getElementById('optionsContainer');
const questionIndex = document.getElementById('questionIndex');
const timerDisplay = document.getElementById('timerDisplay');
const scoreDisplay = document.getElementById('scoreDisplay');
const selectedTypeLabel = document.getElementById('selectedType');
const totalQuestionsLabel = document.getElementById('totalQuestions');
const remainingQuestionsLabel = document.getElementById('remainingQuestions');
const retryWrongInput = document.getElementById('retryWrong');
const resultArea = document.getElementById('resultArea');
const resultSummary = document.getElementById('resultSummary');
const answersList = document.getElementById('answersList');
const retryBtn = document.getElementById('retryBtn');
const closeResultBtn = document.getElementById('closeResultBtn');
const quizTypeSelect = document.getElementById('quizTypeSelect');

let allQuestions = []; // loaded below
let currentSet = []; // filtered by type
let currentIndex = 0;
let answers = []; // user answers per question (arrays of indices)
let score = 0;
let timer = null;
let timeLeft = 20 * 60; // default 20 minutes for full quiz (modifiable)
let questionTimeLimit = 0; // not per-question here, global timer
let wrongQuestions = [];
let retryMode = false;

/* === QUESTIONS DATA (90 questions) ===
   Each question: { id, type: 'QCM'|'QCS'|'VF', question: '', options: [], answer: [indices] }
   For Vrai/Faux options are ["Vrai","Faux"] and answer is [0] or [1]
   The list is ordered from moyen -> trÃ¨s difficile.
*/
allQuestions = [
/* ----- QCM 1..30 (choix multiples) ----- */
{ id: 'qcm1', type:'QCM', question:"Quelles sont les caractÃ©ristiques principales du PalÃ©olithique ?", options:["Agriculture et Ã©levage","Taille de pierre","Chasse et cueillette","MaÃ®trise du feu"], answer:[1,2,3]},
{ id: 'qcm2', type:'QCM', question:"Quelles innovations techniques sont associÃ©es au PalÃ©olithique ?", options:["Fabrication de vÃªtements en peaux","Utilisation de la brique crue","Domestication du chien","Culture des cÃ©rÃ©ales"], answer:[0,2]},
{ id: 'qcm3', type:'QCM', question:"Parmi ces Ã©lÃ©ments, lesquels tÃ©moignent du NÃ©olithique ?", options:["Pierre polie","Poterie et tissage","Agriculture","Nomadisme"], answer:[0,1,2]},
{ id: 'qcm4', type:'QCM', question:"Les Natoufiens sont connus pour :", options:["Villages permanents","AmÃ©nagement des abris naturels","Usage dâ€™arches monumentales","Utilisation de poteaux de bois"], answer:[0,1,3]},
{ id: 'qcm5', type:'QCM', question:"Quels facteurs ont favorisÃ© la sÃ©dentarisation ?", options:["Climat plus chaud","ProximitÃ© des cours dâ€™eau","DisponibilitÃ© de pierres taillÃ©es","FertilitÃ© du sol"], answer:[0,1,3]},
{ id: 'qcm6', type:'QCM', question:"CaractÃ©ristiques de Ã‡atal HÃ¶yÃ¼k :", options:["Maisons agglutinÃ©es","AccÃ¨s par les toits","VoÃ»tes en pierre","Utilisation de brique crue"], answer:[0,1,3]},
{ id: 'qcm7', type:'QCM', question:"Avantages dâ€™un habitat proche dâ€™un cours dâ€™eau :", options:["FertilitÃ© des terres","Transport facile","Protection contre inondations","AccÃ¨s Ã  lâ€™eau potable"], answer:[0,1,3]},
{ id: 'qcm8', type:'QCM', question:"Lâ€™architecture natoufienne comportait :", options:["Cabanes semi-enterrÃ©es","Sols dallÃ©s","Colonnes en pierre","Enduits muraux peints"], answer:[0,1,3]},
{ id: 'qcm9', type:'QCM', question:"Les maisons nÃ©olithiques utilisaient souvent :", options:["Toit plat","MatÃ©riaux locaux","Absence dâ€™Ã©tages","Grandes fenÃªtres"], answer:[0,1,2]},
{ id: 'qcm10', type:'QCM', question:"Pourquoi utiliser la brique crue ?", options:["DisponibilitÃ© des matÃ©riaux","FacilitÃ© de mise en Å“uvre","RÃ©sistance Ã  lâ€™eau","Isolation thermique"], answer:[0,1,3]},
{ id: 'qcm11', type:'QCM', question:"Impact du climat sur lâ€™habitat :", options:["Choix des matÃ©riaux","Organisation des villages","Apparition des arcs","ProximitÃ© des ressources"], answer:[0,1,3]},
{ id: 'qcm12', type:'QCM', question:"Organisation spatiale de Ã‡atal HÃ¶yÃ¼k :", options:["DensitÃ© Ã©levÃ©e","Absence de rues traditionnelles","Grande place centrale","AccÃ¨s par les toits"], answer:[0,1,3]},
{ id: 'qcm13', type:'QCM', question:"MatÃ©riaux utilisÃ©s dans les villages natoufiens :", options:["Pierre brute","Bois","Terre crue","Acier"], answer:[0,1,2]},
{ id: 'qcm14', type:'QCM', question:"Transition PalÃ©olithique â†’ NÃ©olithique inclut :", options:["Agriculture","Ã‰levage","Domestication du cheval","Poterie"], answer:[0,1,3]},
{ id: 'qcm15', type:'QCM', question:"AmÃ©nagement intÃ©rieur natoufien : ", options:["Enduits muraux","Poteaux de soutien","Escaliers intÃ©rieurs","Sols dallÃ©s"], answer:[0,1,3]},
{ id: 'qcm16', type:'QCM', question:"Structures de dÃ©fense naturelles utilisÃ©es :", options:["Utilisation des pentes","Implantation stratÃ©gique","Tours de garde en pierre","Hauteur du terrain"], answer:[0,1,3]},
{ id: 'qcm17', type:'QCM', question:"Ã‰lÃ©ments culturels liÃ©s Ã  lâ€™habitat prÃ©historique :", options:["DÃ©coration murale","Organisation collective","Usage du marbre","Espaces rituels"], answer:[0,1,3]},
{ id: 'qcm18', type:'QCM', question:"DiffÃ©rences majeures PalÃ©olithique/NÃ©olithique :", options:["Nomadisme vs sÃ©dentaritÃ©","Chasse vs agriculture","Usage de fer","Taille vs polissage de pierre"], answer:[0,1,3]},
{ id: 'qcm19', type:'QCM', question:"Avantages des toits plats dans les villages nÃ©olithiques :", options:["Espace de vie extÃ©rieur","AccÃ¨s direct au logement","Isolation contre pluie forte","Stockage"], answer:[0,1,3]},
{ id: 'qcm20', type:'QCM', question:"Raisons dâ€™un habitat dense Ã  Ã‡atal HÃ¶yÃ¼k :", options:["DÃ©fense collective","Limitation dâ€™espace constructible","Confort thermique absolu","Organisation sociale"], answer:[0,1,3]},
{ id: 'qcm21', type:'QCM', question:"Quels indices montrent une premiÃ¨re spÃ©cialisation des tÃ¢ches ?", options:["PrÃ©sence dâ€™ateliers","Objets standardisÃ©s","Grandes habitations aristocratiques","RÃ©serves alimentaires"], answer:[0,1,3]},
{ id: 'qcm22', type:'QCM', question:"Les sols dallÃ©s et enduits indiquent :", options:["Soin de lâ€™habitat","Symbolisme religieux","Technique de stockage","Absence de mobilier"], answer:[0,2]},
{ id: 'qcm23', type:'QCM', question:"La fonction des poteaux circulaires au centre des maisons natoufiennes Ã©tait probablement :", options:["Support de la charpente","Monument funÃ©raire","Espace rituel","SystÃ¨me de ventilation"], answer:[0,2]},
{ id: 'qcm24', type:'QCM', question:"La densitÃ© et l'agglutination des maisons entraÃ®ne :", options:["Circulation par toits","AccÃ¨s privÃ© limitÃ©","PrÃ©sence de rues larges","Organisation collective des terrasses"], answer:[0,1,3]},
{ id: 'qcm25', type:'QCM', question:"Comment la topographie influence-t-elle le choix du site ?", options:["Protection naturelle","Orientation solaire","DisponibilitÃ© dâ€™agrÃ©gats","PrÃ©sence dâ€™arbres"], answer:[0,1]},
{ id: 'qcm26', type:'QCM', question:"La prÃ©sence de foyers fixes indique :", options:["SÃ©dentaritÃ© partielle","ContrÃ´le du feu","ActivitÃ©s culinaires","Rituel social"], answer:[0,1,2,3]},
{ id: 'qcm27', type:'QCM', question:"Quel(s) Ã©lÃ©ment(s) dÃ©finissent un habitat nÃ©olithique avancÃ© ?", options:["Briques de terre","Stockage organisÃ©","ChaÃ®nes dâ€™Ã©change lointaines","Architecture monumentale"], answer:[0,1,2]},
{ id: 'qcm28', type:'QCM', question:"Pourquoi lâ€™orientation des rues (ombre/vent) est importante ?", options:["Confort thermique","Ã‰vacuation des eaux","Signalisation urbaine","AccÃ¨s aux marchÃ©s"], answer:[0,1]},
{ id: 'qcm29', type:'QCM', question:"Indices dâ€™une vie collective Ã  Ã‡atal HÃ¶yÃ¼k :", options:["Rituels domestiques","DÃ©cors muraux communs","Nao de commerce","Murs partagÃ©s entre maisons"], answer:[0,1,3]},
{ id: 'qcm30', type:'QCM', question:"Ce qui fait quâ€™un site prÃ©historique devient un centre majeur :", options:["Ressources abondantes","Emplacement stratÃ©gique","ComplexitÃ© architecturale","PrÃ©sence dâ€™un pouvoir centralisÃ©"], answer:[0,1,2]},

/* ----- QCS 31..60 (choix simple) ----- */
{ id:'qcs31', type:'QCS', question:"Quel animal a Ã©tÃ© domestiquÃ© en premier ?", options:["ChÃ¨vre","Chien","Cheval","BÅ“uf"], answer:[1]},
{ id:'qcs32', type:'QCS', question:"Le NÃ©olithique commence au Proche-Orient vers :", options:["12 000 av. J.-C.","9 000 av. J.-C.","5 500 av. J.-C.","3 300 av. J.-C."], answer:[1]},
{ id:'qcs33', type:'QCS', question:"L'utilisation de la brique crue apparaÃ®t principalement :", options:["Au PalÃ©olithique","Au NÃ©olithique","En MÃ©sopotamie uniquement","En Ã‰gypte ancienne"], answer:[1]},
{ id:'qcs34', type:'QCS', question:"Quel type d'accÃ¨s caractÃ©rise Ã‡atal HÃ¶yÃ¼k ?", options:["Portes sur rue","AccÃ¨s par toits","EntrÃ©es monumentales","Escaliers extÃ©rieurs"], answer:[1]},
{ id:'qcs35', type:'QCS', question:"La prÃ©sence de sols dallÃ©s indique :", options:["Mobilier mobile","SÃ©dentaritÃ© et soin de lâ€™habitat","Absence de pratiques domestiques","Usage rituel uniquement"], answer:[1]},
{ id:'qcs36', type:'QCS', question:"Les poteries apparaissent massivement au :", options:["PalÃ©olithique","Moyen Ã‚ge","NÃ©olithique","AntiquitÃ© tardive"], answer:[2]},
{ id:'qcs37', type:'QCS', question:"Une caractÃ©ristique urbaine naissante est :", options:["PrÃ©sence dâ€™un gouverneur local","Construction en acier","RÃ©seau routier pavÃ©","SystÃ¨mes Ã©lectriques"], answer:[0]},
{ id:'qcs38', type:'QCS', question:"Le plus grand Ã©tablissement nÃ©olithique connu, Ã‡atal HÃ¶yÃ¼k, se situe en :", options:["Ã‰gypte","Anatolie","MÃ©sopotamie","Europe de lâ€™Ouest"], answer:[1]},
{ id:'qcs39', type:'QCS', question:"Quel Ã©lÃ©ment est typiquement absent des maisons nÃ©olithiques ?", options:["FenÃªtres larges","Toits plats","MatÃ©riaux locaux","Absence dâ€™Ã©tages"], answer:[0]},
{ id:'qcs40', type:'QCS', question:"Lâ€™invention de la roue se situe approximativement :", options:["Au PalÃ©olithique","Au NÃ©olithique","Ã€ lâ€™Ã©poque romaine","Au Moyen Ã‚ge"], answer:[1]},
{ id:'qcs41', type:'QCS', question:"Les maisons semi-enterrÃ©es permettent surtout :", options:["Meilleure isolation thermique","Construire des Ã©tages","CrÃ©er des fenÃªtres plus grandes","AccÃ¨s direct par la rue"], answer:[0]},
{ id:'qcs42', type:'QCS', question:"Quel matÃ©riau est le plus utilisÃ© dans les premiÃ¨res constructions permanentes ?", options:["Bois et terre crue","BÃ©ton","Marbre","Acier"], answer:[0]},
{ id:'qcs43', type:'QCS', question:"Les enduits muraux peints tÃ©moignent de :", options:["Fonctions domestiques seulement","Formes dâ€™expression symbolique","Absence de savoir-faire","Imitation romaine"], answer:[1]},
{ id:'qcs44', type:'QCS', question:"La domestication du chien a surtout servi pour :", options:["Transport","Aide Ã  la chasse","Construction","Rituel"], answer:[1]},
{ id:'qcs45', type:'QCS', question:"La prÃ©sence dâ€™un puit funÃ©raire indique :", options:["Pratiques de protection contre pillage","SystÃ¨mes dâ€™irrigation","Habitudes de stockage","Techniques mÃ©tallurgiques"], answer:[0]},
{ id:'qcs46', type:'QCS', question:"Lâ€™organisation en terrasses pour accÃ©der aux maisons est typique de :", options:["Ã‡atal HÃ¶yÃ¼k","Rome","Ã‰gypte","GrÃ¨ce"], answer:[0]},
{ id:'qcs47', type:'QCS', question:"La sÃ©dentarisation entraÃ®ne principalement :", options:["RÃ©duction des Ã©changes","DÃ©veloppement de lâ€™agriculture","Disparition des rituels","Urbanisme moderne"], answer:[1]},
{ id:'qcs48', type:'QCS', question:"Un des premiers indices dâ€™architecture planifiÃ©e est :", options:["PrÃ©sence dâ€™alignements rÃ©guliers de maisons","PrÃ©sence de tours mÃ©diÃ©vales","Usage de marbre","RÃ©seaux dâ€™Ã©gouts"], answer:[0]},
{ id:'qcs49', type:'QCS', question:"Quel critÃ¨re explique la longÃ©vitÃ© du site de Ã‡atal HÃ¶yÃ¼k ?", options:["Isolation complÃ¨te","FertilitÃ© et ressources locales","Climat polaire","PrÃ©sence dâ€™un roi"], answer:[1]},
{ id:'qcs50', type:'QCS', question:"Parmi ces techniques, laquelle nâ€™appartient pas aux dÃ©buts nÃ©olithiques ?", options:["Poterie","Tissage","Usage rÃ©pandu du mÃ©tal","Domestication dâ€™animaux"], answer:[2]},
{ id:'qcs51', type:'QCS', question:"La prÃ©sence de rÃ©serves alimentaires indique :", options:["ActivitÃ© commerciale","Stockage collectif et planification","Structure militaire","Absence dâ€™Ã©levage"], answer:[1]},
{ id:'qcs52', type:'QCS', question:"Les poteaux centraux dans une maison servent principalement Ã  :", options:["Supporter la charpente","Servir dâ€™autel religieux","EntrÃ©e principale","SystÃ¨me dâ€™Ã©vacuation"], answer:[0]},
{ id:'qcs53', type:'QCS', question:"Quel avantage apporte la proximitÃ© d'une riviÃ¨re ?", options:["BarriÃ¨re dÃ©fensive naturelle","Transport et irrigation","Isolation culturelle","Production de marbre"], answer:[1]},
{ id:'qcs54', type:'QCS', question:"Un signe dâ€™occupation permanente est :", options:["PrÃ©sence de mobilier mobile seulement","Construction dâ€™Ã©lÃ©ments fixes comme foyers et silos","Absence de structures durables","MobilitÃ© totale"], answer:[1]},
{ id:'qcs55', type:'QCS', question:"Lâ€™agglutination des maisons Ã  Ã‡atal HÃ¶yÃ¼k favorise :", options:["La vie privÃ©e accrue","Lâ€™organisation collective et la dÃ©fense","La crÃ©ation de grandes places ouvertes","La circulation automobile"], answer:[1]},
{ id:'qcs56', type:'QCS', question:"La poterie dÃ©corÃ©e indique souvent :", options:["Fonction purement utilitaire","Signes dâ€™identitÃ©s et Ã©changes culturels","Absence de hiÃ©rarchie","Techniques mÃ©talliques avancÃ©es"], answer:[1]},
{ id:'qcs57', type:'QCS', question:"Quelle est la principale raison pour laquelle on enterrait les tombes profondÃ©ment ?", options:["Protection contre le pillage","Rituel de fertilitÃ©","DifficultÃ© technique","EsthÃ©tique"], answer:[0]},
{ id:'qcs58', type:'QCS', question:"La construction sur des monticules (tells) est liÃ©e Ã  :", options:["Accumulation de vestiges","PrÃ©dilection pour lâ€™altitude","Usage cÃ©rÃ©moniel","RaretÃ© des matÃ©riaux"], answer:[0]},
{ id:'qcs59', type:'QCS', question:"Une caractÃ©ristique des villages densÃ©ment peuplÃ©s est :", options:["Rues larges et orthogonales","AccÃ¨s par toits et surfaces partagÃ©es","PrÃ©sence dâ€™aqueducs romains","Usage du marbre"], answer:[1]},
{ id:'qcs60', type:'QCS', question:"Pourquoi lâ€™agriculture a-t-elle transformÃ© lâ€™architecture ?", options:["Moins besoin dâ€™abris","Permet stockage et constructions durables","Remplace lâ€™artisanat","Diminue la population"], answer:[1]},

/* ----- VF 61..90 (Vrai/Faux) ----- */
{ id:'vf61', type:'VF', question:"Les Natoufiens vivaient uniquement dans des grottes.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf62', type:'VF', question:"La roue apparaÃ®t au NÃ©olithique.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf63', type:'VF', question:"Ã‡atal HÃ¶yÃ¼k Ã©tait construit en pierre taillÃ©e uniquement.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf64', type:'VF', question:"La sÃ©dentarisation est directement liÃ©e au dÃ©veloppement de lâ€™agriculture.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf65', type:'VF', question:"Les maisons nÃ©olithiques avaient gÃ©nÃ©ralement de grandes fenÃªtres pour la lumiÃ¨re.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf66', type:'VF', question:"Les enduits muraux peints tÃ©moignent dâ€™un souci esthÃ©tique et symbolique.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf67', type:'VF', question:"La brique crue est un matÃ©riau rÃ©pandu dans les premiers villages permanents.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf68', type:'VF', question:"Les foyers fixes sont un indice dâ€™habitat mobile et non permanent.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf69', type:'VF', question:"Les maisons semi-enterrÃ©es offrent une meilleure isolation thermique.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf70', type:'VF', question:"La densitÃ© des constructions empÃªche totalement la vie collective.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf71', type:'VF', question:"Les toits plats peuvent servir dâ€™espace de circulation et dâ€™activitÃ©.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf72', type:'VF', question:"La prÃ©sence dâ€™un puit funÃ©raire sert souvent Ã  protÃ©ger la tombe du pillage.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf73', type:'VF', question:"Les villages nÃ©olithiques nâ€™avaient aucune organisation spatiale.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf74', type:'VF', question:"Les poteaux centraux dans une maison Ã©taient uniquement dÃ©coratifs.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf75', type:'VF', question:"Lâ€™orientation des voies et des habitations pouvait rÃ©pondre Ã  des contraintes climatiques (ombre/vent).", options:["Vrai","Faux"], answer:[0]},
{ id:'vf76', type:'VF', question:"La sÃ©dentarisation nâ€™a eu aucun effet sur la division du travail.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf77', type:'VF', question:"La poterie est un indice de stockage et de sÃ©dentaritÃ©.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf78', type:'VF', question:"La construction en pierre massive est typique de tous les sites nÃ©olithiques.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf79', type:'VF', question:"On trouve des enduits peints et des sols dallÃ©s mÃªme dans des habitats trÃ¨s anciens.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf80', type:'VF', question:"Les maisons agglutinÃ©es favorisent la dÃ©fense collective.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf81', type:'VF', question:"La disponibilitÃ© des ressources locales est secondaire dans le choix du site.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf82', type:'VF', question:"Les villages montrent parfois des signes dâ€™organisation religieuse partagÃ©e.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf83', type:'VF', question:"Les techniques de construction Ã©voluent trÃ¨s rapidement sans lien avec lâ€™Ã©conomie.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf84', type:'VF', question:"Lâ€™accumulation de vestiges (tells) est due Ã  des occupations successives.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf85', type:'VF', question:"Les routes et rues larges sont une caractÃ©ristique permanente des premiers villages.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf86', type:'VF', question:"La spÃ©cialisation des tÃ¢ches peut Ãªtre dÃ©duite des ateliers identifiÃ©s sur les sites.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf87', type:'VF', question:"Les pratiques funÃ©raires nâ€™apportent aucune information sur lâ€™organisation sociale.", options:["Vrai","Faux"], answer:[1]},
{ id:'vf88', type:'VF', question:"Lâ€™Ã©tude des matÃ©riaux (terre, bois) renseigne sur les choix techniques locaux.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf89', type:'VF', question:"La prÃ©sence dâ€™objets standardisÃ©s indique souvent des Ã©changes et spÃ©cialisation.", options:["Vrai","Faux"], answer:[0]},
{ id:'vf90', type:'VF', question:"Les sites majeurs se dÃ©veloppent uniquement pour des raisons religieuses.", options:["Vrai","Faux"], answer:[1]}
];

/* Helper to filter questions by type */
function getQuestionsByType(type) {
  if (type === 'QCM') return allQuestions.filter(q => q.type === 'QCM');
  if (type === 'QCS') return allQuestions.filter(q => q.type === 'QCS');
  return allQuestions.filter(q => q.type === 'VF');
}

/* Open/close modal */
openQuizBtn.addEventListener('click', () => {
  quizModal.style.display = 'flex';
  quizModal.setAttribute('aria-hidden','false');
  selectedTypeLabel.textContent = quizTypeSelect.value;
  resetQuizState();
});
closeQuizBtn.addEventListener('click', closeQuiz);
closeResultBtn.addEventListener('click', closeQuiz);

function closeQuiz() {
  quizModal.style.display = 'none';
  quizModal.setAttribute('aria-hidden','true');
  stopTimer();
  resultArea.style.display = 'none';
}

/* Start quiz */
startBtn.addEventListener('click', () => {
  startQuiz(quizTypeSelect.value);
});

/* End early */
endEarlyBtn.addEventListener('click', () => {
  finishQuiz();
});

/* Navigation */
prevBtn.addEventListener('click', () => {
  saveCurrentAnswer();
  if (currentIndex > 0) currentIndex--;
  renderQuestion();
});
nextBtn.addEventListener('click', () => {
  saveCurrentAnswer();
  if (currentIndex < currentSet.length - 1) currentIndex++;
  renderQuestion();
});

/* Submit */
submitBtn.addEventListener('click', () => {
  saveCurrentAnswer();
  finishQuiz();
});

/* Retry wrong */
retryBtn.addEventListener('click', () => {
  if (wrongQuestions.length === 0) return;
  retryMode = true;
  currentSet = wrongQuestions.map(id => allQuestions.find(q => q.id === id));
  totalQuestionsLabel.textContent = currentSet.length;
  remainingQuestionsLabel.textContent = currentSet.length;
  answers = Array(currentSet.length).fill(null);
  wrongQuestions = [];
  currentIndex = 0;
  score = 0;
  scoreDisplay.textContent = score;
  resultArea.style.display = 'none';
  selectedTypeLabel.textContent = quizTypeSelect.value + ' (reprise)';
  startTimer(); // restart timer if desired
  renderQuestion();
});

/* Utilities */
function resetQuizState(){
  stopTimer();
  resultArea.style.display = 'none';
  selectedTypeLabel.textContent = quizTypeSelect.value;
  totalQuestionsLabel.textContent = 30;
  remainingQuestionsLabel.textContent = 30;
  questionText.textContent = "Choisissez un type puis cliquez sur Commencer.";
  optionsContainer.innerHTML = '';
  questionIndex.textContent = "Question â€”";
  scoreDisplay.textContent = '0';
  startBtn.disabled = false;
  submitBtn.style.display = 'none';
  prevBtn.disabled = true;
  nextBtn.disabled = true;
}

function startQuiz(type) {
  retryMode = false;
  selectedTypeLabel.textContent = type;
  currentSet = getQuestionsByType(type);
  // shuffle to vary? the user asked ordered from moyen->difficile; keep order as is
  // currentSet = shuffle(currentSet);
  answers = Array(currentSet.length).fill(null);
  currentIndex = 0;
  score = 0;
  wrongQuestions = [];
  totalQuestionsLabel.textContent = currentSet.length;
  remainingQuestionsLabel.textContent = currentSet.length;
  startBtn.disabled = true;
  submitBtn.style.display = 'inline-block';
  prevBtn.disabled = false;
  nextBtn.disabled = false;
  scoreDisplay.textContent = score;
  // start timer
  timeLeft = 20 * 60; // full set 20 minutes default â€” you can adjust
  startTimer();
  renderQuestion();
}

/* Timer */
function startTimer() {
  stopTimer();
  updateTimerDisplay();
  timer = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      stopTimer();
      finishQuiz();
    }
  }, 1000);
}
function stopTimer() {
  if (timer) { clearInterval(timer); timer = null; }
}
function updateTimerDisplay() {
  const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const s = (timeLeft%60).toString().padStart(2,'0');
  timerDisplay.textContent = `${m}:${s}`;
}

/* Render question */
function renderQuestion(){
  const q = currentSet[currentIndex];
  questionIndex.textContent = `Question ${currentIndex+1} / ${currentSet.length}`;
  questionText.textContent = q.question;
  optionsContainer.innerHTML = '';
  remainingQuestionsLabel.textContent = currentSet.length - currentIndex;
  selectedTypeLabel.textContent = quizTypeSelect.value + (retryMode ? ' (reprise)' : '');
  // build options depending on type
  if (q.type === 'QCM') {
    q.options.forEach((opt, i) => {
      const div = document.createElement('label');
      div.className = 'option';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.name = 'opt';
      input.value = i;
      // restore previous selection if any
      const prev = answers[currentIndex];
      if (Array.isArray(prev) && prev.includes(i)) input.checked = true;
      div.appendChild(input);
      const span = document.createElement('span');
      span.textContent = opt;
      div.appendChild(span);
      optionsContainer.appendChild(div);
    });
  } else if (q.type === 'QCS') {
    q.options.forEach((opt, i) => {
      const div = document.createElement('label');
      div.className = 'option';
      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'opt';
      input.value = i;
      if (Array.isArray(answers[currentIndex]) && answers[currentIndex][0] === i) input.checked = true;
      div.appendChild(input);
      const span = document.createElement('span');
      span.textContent = opt;
      div.appendChild(span);
      optionsContainer.appendChild(div);
    });
  } else { // VF
    ['Vrai','Faux'].forEach((opt, i) => {
      const div = document.createElement('label');
      div.className = 'option';
      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'opt';
      input.value = i;
      if (Array.isArray(answers[currentIndex]) && answers[currentIndex][0] === i) input.checked = true;
      div.appendChild(input);
      const span = document.createElement('span');
      span.textContent = opt;
      div.appendChild(span);
      optionsContainer.appendChild(div);
    });
  }

  // update nav buttons
  prevBtn.disabled = currentIndex === 0;
  nextBtn.disabled = currentIndex === currentSet.length - 1;
}

/* Save answer for current question */
function saveCurrentAnswer(){
  const q = currentSet[currentIndex];
  const inputs = Array.from(optionsContainer.querySelectorAll('input[name="opt"]'));
  if (q.type === 'QCM') {
    const chosen = inputs.filter(i => i.checked).map(i => parseInt(i.value));
    answers[currentIndex] = chosen.length ? chosen : null;
  } else {
    const chosen = inputs.find(i => i.checked);
    answers[currentIndex] = chosen ? [parseInt(chosen.value)] : null;
  }
}

/* Finish quiz, compute score */
function finishQuiz(){
  stopTimer();
  // ensure last answer saved
  saveCurrentAnswer();
  // compute
  score = 0;
  wrongQuestions = [];
  currentSet.forEach((q, idx) => {
    const userAns = answers[idx];
    const correct = q.answer;
    // compare arrays (order insensitive)
    if (!userAns || userAns.length === 0) {
      wrongQuestions.push(q.id);
      return;
    }
    // for QCM: require exact match of sets
    const sortedUser = userAns.slice().sort((a,b)=>a-b);
    const sortedCorr = correct.slice().sort((a,b)=>a-b);
    const equal = sortedUser.length === sortedCorr.length && sortedUser.every((v,i)=>v===sortedCorr[i]);
    if (equal) {
      score++;
    } else {
      wrongQuestions.push(q.id);
    }
  });

  scoreDisplay.textContent = score + " / " + currentSet.length;
  // show results
  showResults();
}

/* Show result details and correct answers */
function showResults(){
  resultArea.style.display = 'block';
  // summary
  resultSummary.innerHTML = `<p>Vous avez obtenu <strong>${score}</strong> sur <strong>${currentSet.length}</strong>.</p>
    <p>Questions correctes : ${score}. Questions incorrectes : ${currentSet.length - score}.</p>`;
  // list answers
  answersList.innerHTML = '';
  currentSet.forEach((q, idx) => {
    const userAns = answers[idx];
    const corr = q.answer;
    const item = document.createElement('div');
    item.className = 'answer-item';
    const title = document.createElement('div');
    title.style.fontWeight = '700';
    title.textContent = `Q${idx+1} â€” ${q.question}`;
    item.appendChild(title);
    // user's answer
    const ua = document.createElement('div');
    ua.style.marginTop = '8px';
    let uaText = 'Votre rÃ©ponse : ';
    if (!userAns || userAns.length === 0) uaText += '<em>Pas de rÃ©ponse</em>';
    else uaText += userAns.map(i => q.options[i]).join(', ');
    ua.innerHTML = uaText;
    item.appendChild(ua);
    // correct answer
    const ca = document.createElement('div');
    ca.style.marginTop = '6px';
    ca.innerHTML = `<strong>RÃ©ponse correcte :</strong> ${corr.map(i => q.options[i]).join(', ')}`;
    item.appendChild(ca);
    // mark wrong/correct
    const mark = document.createElement('div');
    mark.style.marginTop = '8px';
    const isCorrect = userAns && userAns.length && (userAns.slice().sort().toString() === corr.slice().sort().toString());
    mark.innerHTML = isCorrect ? `<span style="color:green;font-weight:700">âœ” Bonne rÃ©ponse</span>` : `<span style="color:#d6336c;font-weight:700">âœ– Mauvaise rÃ©ponse</span>`;
    item.appendChild(mark);
    answersList.appendChild(item);
  });

  // prepare wrongQuestions (ids already set)
  // If retry is unchecked, disable retry button
  if (!retryWrongInput.checked || wrongQuestions.length === 0) {
    retryBtn.disabled = true;
  } else {
    retryBtn.disabled = false;
  }
}

/* Optional: shuffle function if you want randomized order
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
*/

</script>
</body>
</html>
